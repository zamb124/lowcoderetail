{# core_sdk/frontend/templates/fields/_input_inline.html #}
{# Ожидает: field_ctx, item_id, model_name, request, url_for #}
{% set input_type = 'text' %}
{% set current_value = field_ctx.value %} {# Используем отдельную переменную для значения #}

{% if field_ctx.field_type == 'number' %}
    {% set input_type = 'number' %}
{% elif field_ctx.field_type == 'datetime' %}
     {% set input_type = 'datetime-local' %}
     {% set current_value = field_ctx.value.strftime('%Y-%m-%dT%H:%M') if field_ctx.value and hasattr(field_ctx.value, 'strftime') else '' %}
{% elif field_ctx.field_type == 'date' %}
     {% set input_type = 'date' %}
     {% set current_value = field_ctx.value.strftime('%Y-%m-%d') if field_ctx.value and hasattr(field_ctx.value, 'strftime') else '' %}
{% elif field_ctx.field_type == 'time' %}
     {% set input_type = 'time' %}
     {% set current_value = field_ctx.value.strftime('%H:%M') if field_ctx.value and hasattr(field_ctx.value, 'strftime') else '' %}
{% elif field_ctx.field_type == 'email' %}
     {% set input_type = 'email' %}
{% elif field_ctx.field_type == 'url' %}
     {% set input_type = 'url' %}
{% else %}
    {% set current_value = field_ctx.value | default('', true) %}
{% endif %}

{# --- Для Checkbox --- #}
{% if field_ctx.field_type == 'checkbox' %}
<div class="form-check form-check-custom form-check-solid form-check-sm d-inline-block">
    <input class="form-check-input" type="checkbox" value="true" {# Отправляем "true" #}
           id="{{ field_ctx.html_id }}--inline-input"
           name="{{ field_ctx.html_name }}"
           {% if field_ctx.value == True %}checked{% endif %}
           {% if field_ctx.is_readonly %}disabled{% endif %}
           hx-put="{{ url_for('update_inline_field', model_name=model_name, item_id=item_id, field_name=field_ctx.name) }}"
           hx-ext="json-enc"
           hx-trigger="change"
           hx-target="closest td"
           hx-swap="innerHTML"
           hx-indicator="closest td"
           autofocus>
</div>
{# --- Для Select (Enum) --- #}
{% elif field_ctx.field_type == 'relation' %}
 <select class="form-select form-select-solid {% if field_ctx.errors %}is-invalid{% endif %}"
            {# Атрибуты для Choices.js #}
            data-control="choicesjs"
            data-placeholder="{{ field_ctx.extra.get('placeholder', 'Выберите ' ~ field_ctx.label ~ '...') }}"
            data-allow-clear="{{ 'true' if field_ctx.extra.get('allow_clear', True) and not field_ctx.is_required else 'false' }}"
            data-load-options-url="{{ url_for('get_select_options', model_name=field_ctx.extra.relation_model_name) }}"
            data-search-enabled="{{ field_ctx.extra.get('search_enabled', 'true') }}"
            data-remove-item-button="{{ field_ctx.extra.get('remove_item_button', 'true') }}"
            hx-put="{{ url_for('update_inline_field', model_name=model_name, item_id=item_id, field_name=field_ctx.name) }}"
            hx-ext="json-enc"
            hx-trigger="change"
            hx-target="closest td"
            hx-swap="innerHTML"
            hx-indicator="closest td"
            id="{{ field_ctx.html_id }}--inline-input"
            name="{{ field_ctx.html_name }}"
            {# {% if field_ctx.is_readonly %}disabled{% endif %} #} {# Choices.js должен подхватить disabled #}
            {% if field_ctx.is_required %}required{% endif %}
            aria-describedby="{{ field_ctx.html_id }}_help {{ field_ctx.html_id }}_errors">

        {# Предзагрузка текущего значения, если оно есть. #}
        {# Choices.js сможет его использовать при инициализации. #}
        {% if field_ctx.value %}
            {# Если field_ctx.options уже содержит текущее значение (например, из _load_options в SDKField), #}
            {# то оно будет выбрано. Иначе, добавляем его явно. #}
            {% set current_value_str = field_ctx.value | string %}
            {% set found_in_options = false %}
            {% if field_ctx.options %}
                {% for opt_val, opt_label in field_ctx.options %}
                    {% if opt_val | string == current_value_str %}
                        <option value="{{ opt_val }}" selected>{{ opt_label }}</option>
                        {% set found_in_options = true %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if not found_in_options %}
                {# Если текущего значения нет в field_ctx.options (которые SDKField._load_options мог загрузить), #}
                {# добавляем его. TitleResolver на клиенте может позже обновить label, если нужно, #}
                {# но для Choices.js важно, чтобы <option> существовал для начального значения. #}
                {# Мы не знаем display_name здесь, поэтому используем ID или "Загрузка..." #}
                <option value="{{ current_value_str }}" selected>
                    ID: {{ current_value_str | truncate(8, True, '...') }} (Загрузка названия...)
                </option>
            {% endif %}
        {% else %}
             <option value=""></option> {# Пустая опция для placeholder, если значение не выбрано #}
        {% endif %}
    </select>
{# --- Для остальных (text, number, datetime, etc.) --- #}
{% else %}
<input type="{{ input_type }}"
       class="form-control form-control-sm form-control-solid {% if field_ctx.errors %}is-invalid{% endif %}"
       id="{{ field_ctx.html_id }}--inline-input" {# Уникальный ID #}
       name="{{ field_ctx.html_name }}"
       value="{{ current_value }}"
       {% if field_ctx.is_readonly %}readonly disabled{% endif %}
       {% if field_ctx.is_required %}required{% endif %}
       placeholder="{{ field_ctx.label }}"
       hx-put="{{ url_for('update_inline_field', model_name=model_name, item_id=item_id, field_name=field_ctx.name) }}"
       hx-ext="json-enc" {# <--- ДОБАВЛЕНО ЗДЕСЬ #}
       hx-trigger="blur, keyup[key=='Enter']"
       hx-target="closest td"
       hx-swap="innerHTML"
       hx-indicator="closest td"
       autofocus>
{% endif %}

{% if field_ctx.errors %}
    <div style="color: red; font-size: 0.8em; border: 1px solid red; padding: 2px; display: block !important;">
        ОШИБКА: {{ field_ctx.errors | join(', ') }}
    </div>
{% endif %}