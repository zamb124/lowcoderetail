{# core_sdk/frontend/templates/fields/list_relation_select.html #}
{# Ожидает: field_ctx, url_for, ctx (для data-bs-container тултипа) #}
{# field_ctx.value здесь - это список UUID (или строк UUID) #}

<div class="form-floating mb-3"> {# Используем form-floating для консистентности #}
    <select multiple
            class="form-select {% if field_ctx.errors %}is-invalid{% endif %}"
            data-control="choicesjs"
            data-placeholder="{{ field_ctx.extra.get('placeholder', 'Выберите ' ~ field_ctx.label ~ '...') }}"
            data-allow-clear="false" {# Для мультиселекта allow-clear обычно не используется так #}
            data-load-options-url="{{ url_for('get_select_options', model_name=field_ctx.extra.relation_model_name) }}"
            data-search-enabled="{{ field_ctx.extra.get('search_enabled', 'true') }}"
            data-remove-item-button="true" {# Для мультиселекта это включает крестики на тегах #}
            id="{{ field_ctx.html_id }}"
            name="{{ field_ctx.html_name }}" {# Имя поля для отправки (будет список значений) #}
            {% if field_ctx.is_readonly %}disabled{% endif %}
            {% if field_ctx.is_required %}required{% endif %}
            aria-label="{{ field_ctx.label }}"
            aria-describedby="{{ field_ctx.html_id }}_help {{ field_ctx.html_id }}_errors">

        {# Предзагрузка текущих выбранных значений #}
        {# field_ctx.value - это список UUID #}
        {# field_ctx.options - это список (value, label) для УЖЕ ВЫБРАННЫХ элементов, #}
        {# который мог подготовить SDKField._load_options #}
        {% if field_ctx.value and field_ctx.value is iterable and field_ctx.value is not string %}
            {% for current_id_val in field_ctx.value %}
                {% set current_id_str = current_id_val | string %}
                {% set found_label = null %}
                {% if field_ctx.options %}
                    {% for opt_val, opt_label in field_ctx.options %}
                        {% if opt_val | string == current_id_str %}
                            {% set found_label = opt_label %}
                            <option value="{{ opt_val }}" selected>{{ opt_label }}</option>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if not found_label %}
                    {# Если лейбл не был предзагружен через field_ctx.options, #}
                    {# ComponentInitializer.initChoicesJs (через TitleResolver, если мы его вернем для этого) #}
                    {# или специальная логика в initChoicesJs попытается загрузить лейбл. #}
                    {# Пока просто отображаем ID. #}
                    <option value="{{ current_id_str }}" selected>
                        ID: {{ current_id_str | truncate(12, True, '...') }}
                    </option>
                {% endif %}
            {% endfor %}
        {% endif %}
        {# Пустая опция не нужна для мультиселекта, если есть placeholder в JS #}
    </select>
    <label for="{{ field_ctx.html_id }}">
        {{ field_ctx.label }}{% if field_ctx.is_required %}<span class="text-danger">*</span>{% endif %}

    </label>
{% if field_ctx.description %}
            <span class="form-floating-info-icon"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-container="{% if ctx and ctx.extra and ctx.extra.modal_container_id %}{{ '#' ~ ctx.extra.modal_container_id }}{% else %}body{% endif %}"
                  title="{{ field_ctx.description | escape }}">
        <i class="ti ti-info-circle text-muted"></i>
    </span>
        {% endif %}

    {% if field_ctx.errors %}
        <div class="invalid-feedback"> {# Bootstrap должен сам показать это для is-invalid #}
            {{ field_ctx.errors | join(', ') }}
        </div>
    {% endif %}
</div>