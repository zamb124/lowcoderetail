{# core_sdk/frontend/templates/fields/relation_select.html #}
{# Ожидает: field_ctx (FieldRenderContext), url_for #}
<div class="mb-5 fv-row">
    <label for="{{ field_ctx.html_id }}" class="form-label fs-6 fw-semibold {% if field_ctx.is_required %}required{% endif %}">
        {{ field_ctx.label }}
    </label>
    <select class="form-select form-select-solid {% if field_ctx.errors %}is-invalid{% endif %}"
            {# Атрибуты для Choices.js #}
            data-control="choicesjs"
            data-placeholder="{{ field_ctx.extra.get('placeholder', 'Выберите ' ~ field_ctx.label ~ '...') }}"
            data-allow-clear="{{ 'true' if field_ctx.extra.get('allow_clear', True) and not field_ctx.is_required else 'false' }}"
            data-load-options-url="{{ url_for('get_select_options', model_name=field_ctx.extra.relation_model_name) }}"
            data-search-enabled="{{ field_ctx.extra.get('search_enabled', 'true') }}"
            data-remove-item-button="{{ field_ctx.extra.get('remove_item_button', 'true') }}"
            id="{{ field_ctx.html_id }}"
            name="{{ field_ctx.html_name }}"
            {# {% if field_ctx.is_readonly %}disabled{% endif %} #} {# Choices.js должен подхватить disabled #}
            {% if field_ctx.is_required %}required{% endif %}
            aria-describedby="{{ field_ctx.html_id }}_help {{ field_ctx.html_id }}_errors">

        {# Предзагрузка текущего значения, если оно есть. #}
        {# Choices.js сможет его использовать при инициализации. #}
        {% if field_ctx.value %}
            {# Если field_ctx.options уже содержит текущее значение (например, из _load_options в SDKField), #}
            {# то оно будет выбрано. Иначе, добавляем его явно. #}
            {% set current_value_str = field_ctx.value | string %}
            {% set found_in_options = false %}
            {% if field_ctx.options %}
                {% for opt_val, opt_label in field_ctx.options %}
                    {% if opt_val | string == current_value_str %}
                        <option value="{{ opt_val }}" selected>{{ opt_label }}</option>
                        {% set found_in_options = true %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if not found_in_options %}
                {# Если текущего значения нет в field_ctx.options (которые SDKField._load_options мог загрузить), #}
                {# добавляем его. TitleResolver на клиенте может позже обновить label, если нужно, #}
                {# но для Choices.js важно, чтобы <option> существовал для начального значения. #}
                {# Мы не знаем display_name здесь, поэтому используем ID или "Загрузка..." #}
                <option value="{{ current_value_str }}" selected>
                    ID: {{ current_value_str | truncate(8, True, '...') }} (Загрузка названия...)
                </option>
            {% endif %}
        {% else %}
             <option value=""></option> {# Пустая опция для placeholder, если значение не выбрано #}
        {% endif %}
    </select>

    {% if field_ctx.description %}
        <div id="{{ field_ctx.html_id }}_help" class="form-text text-muted mt-1">{{ field_ctx.description }}</div>
    {% endif %}

    {% if field_ctx.errors %}
        <div id="{{ field_ctx.html_id }}_errors" class="invalid-feedback mt-1">
            {{ field_ctx.errors | join(', ') }}
        </div>
    {% endif %}
</div>