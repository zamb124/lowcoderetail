{# Ожидает: field_ctx (FieldRenderContext), url_for #}
{# Базовый select, который будет улучшен JS (TomSelect/Choices.js) #}
<div class="mb-5 fv-row">
    <label for="{{ field_ctx.html_id }}" class="form-label fs-6 fw-semibold {% if field_ctx.is_required %}required{% endif %}">
        {{ field_ctx.label }}
    </label>
    <select class="form-select form-select-solid {% if field_ctx.errors %}is-invalid{% endif %}"
            {# Атрибуты для JS-инициализации #}
            data-control="select2" {# Или 'tom-select', 'choices' #}
            data-placeholder="Выберите {{ field_ctx.label }}..."
            data-allow-clear="true"
            {# URL для загрузки опций (JS будет использовать его) #}
            data-load-options-url="{{ url_for('get_select_options', model_name=field_ctx.extra.relation_model_name) }}"
            id="{{ field_ctx.html_id }}"
            name="{{ field_ctx.html_name }}"
            {% if field_ctx.is_readonly %}disabled{% endif %}
            {% if field_ctx.is_required %}required{% endif %}
            aria-describedby="{{ field_ctx.html_id }}_help {{ field_ctx.html_id }}_errors">
        <option></option> {# Пустая опция для placeholder #}
        {# Опции будут загружены через JS, но можно предзагрузить текущее значение, если оно есть #}
        {% if field_ctx.value %}
             {# Ищем текущее значение в предзагруженных опциях (если они были) #}
             {% set found = false %}
             {% for opt_value, opt_label in field_ctx.options %}
                 {% if opt_value == field_ctx.value %}
                     <option value="{{ opt_value }}" selected>{{ opt_label }}</option>
                     {% set found = true %}
                 {% endif %}
             {% endfor %}
             {# Если не нашли в опциях, добавляем его, чтобы JS мог отобразить #}
             {% if not found %}
                 <option value="{{ field_ctx.value }}" selected>{{ field_ctx.value }} (Загрузка...)</option>
             {% endif %}
        {% endif %}
    </select>

    {% if field_ctx.description %}
        <div id="{{ field_ctx.html_id }}_help" class="form-text text-muted mt-1">{{ field_ctx.description }}</div>
    {% endif %}

    {% if field_ctx.errors %}
        <div id="{{ field_ctx.html_id }}_errors" class="invalid-feedback mt-1">
            {{ field_ctx.errors | join(', ') }}
        </div>
    {% endif %}
</div>
{# TODO: Добавить JS для инициализации Select2/TomSelect/Choices.js с асинхронной загрузкой #}
{# Примерно так (в app.js):
   document.querySelectorAll('[data-control="select2"][data-load-options-url]').forEach(el => {
       $(el).select2({
           ajax: {
               url: el.dataset.loadOptionsUrl,
               data: function (params) { return { q: params.term }; },
               processResults: function (data) { return { results: data.map(item => ({id: item.value, text: item.label})) }; }
           }
       });
   });
#}