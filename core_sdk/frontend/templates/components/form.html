{# core_sdk/frontend/templates/components/form.html #}
{# Ожидает: ctx (RenderContext), request, user, SDK_STATIC_URL, url_for #}
{# Этот шаблон теперь представляет собой ПОЛНУЮ форму, включая тег <form> и кнопки. #}
{# Он будет вставлен в .modal-body. #}

{% set form_action_url = url_for('update_item', model_name=ctx.model_name, item_id=ctx.item_id) if ctx.mode == 'edit' else url_for('create_item', model_name=ctx.model_name) %}
{% set form_method = 'put' if ctx.mode == 'edit' else 'post' %}

{# Определяем, загружен ли этот контент в модальное окно Bootstrap #}
{# Проверяем, был ли hx-target на .modal-body или .modal-content #}
{% set is_inside_modal_body = request.headers.get("HX-Target") and (".modal-body" in request.headers.get("HX-Target") or ".modal-content" in request.headers.get("HX-Target")) %}
{# Или если ID самого элемента формы (ctx.html_id) содержит "modal", это тоже признак #}
{% if not is_inside_modal_body and ctx.html_id and "modal" in ctx.html_id %}
    {% set is_inside_modal_body = true %}
{% endif %}


<form id="{{ ctx.html_id }}"
      hx-{{ form_method }}="{{ form_action_url }}"
      hx-ext="json-enc"
      {# При ошибке валидации (422), сервер вернет этот же form.html с ошибками. #}
      {# HTMX заменит содержимое .modal-body (или другого hx-target изначального запроса) #}
      {# на этот новый HTML формы. #}
      hx-target="this" {# Форма заменяет саму себя при ответе (успех или ошибка с HTML) #}
      hx-swap="outerHTML" {# Заменяем весь тег <form> #}
      {# Если успешный ответ 204, то сработает HX-Trigger: closeModal #}
      class="form-component-wrapper" {# Добавим класс для возможной стилизации #}
      ui_key="{{ ctx.model_name }}--{{ ctx.item_id if ctx.item_id else 'new' }}"
      data-lsn="{{ ctx.item.lsn if ctx.item and ctx.item.lsn else '0' }}">

    {# Заголовок формы (если нужен внутри этого компонента) #}
    {# <h4 class="mb-4">{{ ctx.title }}</h4> #}
    {# Обычно заголовок уже есть в модалке или на странице. #}

    {# Отображение общих ошибок формы #}
    {% if ctx.errors and ctx.errors._form %}
        <div class="alert alert-danger d-flex align-items-center p-4 mb-5">
            <i class="ki-duotone ki-information-5 fs-2hx text-danger me-3"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
            <div class="d-flex flex-column">
                <h5 class="mb-1 text-danger">Ошибка</h5>
                <span>
                    {% if ctx.errors._form is iterable and ctx.errors._form is not string %}
                        {{ ctx.errors._form | join('<br>') | safe }}
                    {% else %}
                        {{ ctx.errors._form | safe }}
                    {% endif %}
                </span>
            </div>
        </div>
    {% endif %}

    {# Отображение полей #}
    {% for field_ctx_loopvar in ctx.fields %}
         {% set field_errors = ctx.errors.get(field_ctx_loopvar.name) if ctx.errors and ctx.errors is mapping else None %}
         {% set current_field_ctx = field_ctx_loopvar.model_copy(update={'errors': field_errors}) %}
         {% with field_ctx=current_field_ctx, request=request, user=user, SDK_STATIC_URL=SDK_STATIC_URL, url_for=url_for, ctx=ctx %}
            {% include current_field_ctx.template_path %}
         {% endwith %}
    {% endfor %}

    {# Футер с кнопками ВНУТРИ формы #}
    <div class="pt-5 mt-3 border-top"> {# Отступ и линия #}
        <div class="d-flex justify-content-end">
            {% if is_inside_modal_body %}
                <button type="button" class="btn btn-light me-3" data-bs-dismiss="modal">Отмена</button>
            {% elif ctx.mode == 'edit' %}
                <button type="button" class="btn btn-light me-3"
                        hx-get="{{ url_for('get_view', model_name=ctx.model_name, item_id=ctx.item_id) }}"
                        hx-target="#{{ ctx.html_id }}" {# Заменяем эту форму на view #}
                        hx-swap="outerHTML">
                    Отмена
                </button>
            {% else %} {# Режим CREATE на отдельной странице #}
                <a href="{{ url_for('get_list_view', model_name=ctx.model_name).replace('/sdk','') }}" class="btn btn-light me-3">
                    Отмена
                </a>
            {% endif %}

            <button type="submit" class="btn btn-primary">
                 <span class="indicator-label">Сохранить</span>
                 <span class="indicator-progress d-none">Пожалуйста, подождите...
                     <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                 </span>
            </button>
        </div>
    </div>
</form>